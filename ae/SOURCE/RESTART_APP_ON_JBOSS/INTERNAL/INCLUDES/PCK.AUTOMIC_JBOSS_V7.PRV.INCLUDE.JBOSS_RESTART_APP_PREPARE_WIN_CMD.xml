<?xml version="1.0" encoding="ISO-8859-15" standalone="no"?><uc-export clientvers="11.0.0">
<JOBI name="PCK.AUTOMIC_JBOSS_V7.PRV.INCLUDE.JBOSS_RESTART_APP_PREPARE_WIN_CMD">
<HEADER state="1">
<Title>Prepare Windows Command</Title>
<ArchiveKey1/>
<ArchiveKey2/>
<OH_SubType/>
</HEADER>
<SCRIPT mode="1" state="1">
<MSCRI><![CDATA[:SET &NL# = UC_CRLF()

:SET &UC4RB_CONVERTED_STRING# = &UC4RB_AIOPS_JB_HOME_DIR#
:INCLUDE PCK.ITPA_SHARED.PRV.INCLUDE.CONVERT_SLASHES_WINDOWS_STYLE
:SET &UC4RB_AIOPS_JB_HOME_DIR# = &UC4RB_CONVERTED_STRING#

:INCLUDE PCK.AUTOMIC_JBOSS_V7.PRV.INCLUDE.JBOSS_CLI@WIN

!---------------------- Enable application command  ----------------------
:SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI# --command=`"deploy --name=&UC4RB_AIOPS_JB_APP_NAME#'

:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Managed Domain"
:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# = ""
:    SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI_ENABLE_APP# --all-server-groups'
:  ELSE
:    SET &UC4_JBOSS_CLI_ENABLE_APP# = "&UC4_JBOSS_CLI_ENABLE_APP# --server-groups='&UC4RB_AIOPS_JB_SERVER_GRPS#'"
:  ENDIF
:ENDIF

:SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI_ENABLE_APP#`"'

: SET &UC4RB_CMD_WIN# =  'powershell {&NL#')
! --------------------------------------
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$fileExist=((Test-Path  &UC4_AIOPS_JB_HOME_DIR#)) &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if (!$fileExist) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  Write-Host "ERROR: Cannot find the JBoss path. Aborting ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')
! Escaped jboss-cli.bat
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$env:NOPAUSE="True" &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'cmd /c "&UC4_JBOSS_CLI# ')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '--command=`"quit`""')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' | Out-Null &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if (!$?) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  Write-Host "ERROR: JBoss is not running or cannot connect to JBoss CLI using the given inputs. Aborting ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'Write-Host "Checking &UC4RB_AIOPS_JB_APP_NAME# status ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$output=$(cmd /c "&UC4_JBOSS_CLI# ')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '--command=`"deployment-info --name=&UC4RB_AIOPS_JB_APP_NAME#`"')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '") &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$output | findstr /C:" not found" | Out-Null &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if ($?) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' Write-host "ERROR: &UC4RB_AIOPS_JB_APP_NAME# does not exist. Aborting ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')

:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Standalone"
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  $output | findstr /R /C:" FAILED *$" | Out-Null &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  if ($?) { &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '    Write-Host "ERROR: &UC4RB_AIOPS_JB_APP_NAME# is currently in FAILED status. Aborting ..." &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '    exit 1 &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  } &NL#')


:ELSE

:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# NE ""
:    DEFINE &SERVER_GROUPS#,string, 100
:    FILL &SERVER_GROUPS#[] = STR_SPLIT(&UC4RB_AIOPS_JB_SERVER_GRPS#,",")
:    SET &VAR# = 1
:    WHILE &SERVER_GROUPS#[&VAR#] NE ""
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' $output | findstr /R /C:"^&SERVER_GROUPS#[&VAR#] " | Out-Null &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' if (!$?) { &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   Write-host "ERROR: Server group: &SERVER_GROUPS#[&VAR#] does not exist. Aborting ..." &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   exit 1 &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' } &NL#')

:      SET &VAR# = &VAR# + 1
:    ENDWHILE
:  ENDIF

:ENDIF

! ------------------- Enable Application -------------------

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'Write-Host "Enabling &UC4RB_AIOPS_JB_APP_NAME# on JBoss (&UC4RB_AIOPS_JB_OPERATING_MODE#) ..." &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$output = $(cmd /c "&UC4_JBOSS_CLI_ENABLE_APP#") &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if( !$? ) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  Write-Host "ERROR: Failed to start &UC4RB_AIOPS_JB_APP_NAME# in JBoss (&UC4RB_AIOPS_JB_OPERATING_MODE#). Aborting ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$output | findstr /C:" operation failed " | Out-Null &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if ($?) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  Write-Host "ERROR: Failed to start &UC4RB_AIOPS_JB_APP_NAME# in JBoss (&UC4RB_AIOPS_JB_OPERATING_MODE#). Aborting ..." &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')

! --------------------------------------

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'Write-Host "Enabling process finished. Checking &UC4RB_AIOPS_JB_APP_NAME# status again ..." &NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '$output=$(cmd /c "&UC4_JBOSS_CLI# ')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '--command=`"deployment-info --name=&UC4RB_AIOPS_JB_APP_NAME#`"')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '") &NL#')


: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'if( !$? ) { &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  Write-Host ERROR: "Could not get the Application Status. " &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' exit 1 &NL#')
: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '} &NL#')

:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Managed Domain"

:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# = ""
!    Return error if the application is still enabled or not added in 1 or more server groups
:    SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' $output | findstr /R /C:" not added *$" | Out-Null &NL#')
:    SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' if ($?) { &NL#')
:    SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   Write-Host "ERROR: &UC4RB_AIOPS_JB_APP_NAME# is not assigned to all server groups. Aborting ..." &NL#')
:    SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   exit 1 &NL#')
:    SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' } &NL#')

:  ELSE
:    SET &VAR# = 1
:    WHILE &SERVER_GROUPS#[&VAR#] NE ""
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '  $output | findstr /R /C:"&SERVER_GROUPS#[&VAR#] * not added *$" | Out-Null &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' if ($?) { &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '    Write-Host "ERROR: Failed to assign &UC4RB_AIOPS_JB_APP_NAME# to server group &SERVER_GROUPS#[&VAR#]. Aborting ..." &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '    exit 1 &NL#')
:      SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' } &NL#')
:      SET &VAR# = &VAR# + 1
:    ENDWHILE
:  ENDIF

:ELSE

:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' $output | findstr /R /C:" OK *$" | Out-Null &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' if (!$?) { &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   Write-Host "ERROR: &UC4RB_AIOPS_JB_APP_NAME# is not enabled in JBoss Standalone. Aborting ..." &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '   exit 1 &NL#')
:  SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, ' } &NL#')
:ENDIF

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, 'Write-Host "Application successfully restarted."&NL#')

: SET &UC4RB_CMD_WIN# = STR_CAT(&UC4RB_CMD_WIN#, '}')]]></MSCRI>
</SCRIPT>
<DOCU_Docu state="1" type="text">
<DOC/>
</DOCU_Docu>
</JOBI>
</uc-export>