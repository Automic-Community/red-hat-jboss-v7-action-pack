<?xml version="1.0" encoding="ISO-8859-15" standalone="no"?><uc-export clientvers="11.0.0">
<JOBI name="PCK.AUTOMIC_JBOSS_V7.PRV.INCLUDE.JBOSS_RESTART_APP_PREPARE_UNIX_CMD">
<HEADER state="1">
<Title>Prepare Unix Command</Title>
<ArchiveKey1/>
<ArchiveKey2/>
<OH_SubType/>
</HEADER>
<SCRIPT mode="1" state="1">
<MSCRI><![CDATA[:SET &NL# = UC_CRLF()

:SET &UC4RB_CONVERTED_STRING# = &UC4RB_AIOPS_JB_HOME_DIR#
:INCLUDE PCK.ITPA_SHARED.PRV.INCLUDE.CONVERT_SLASHES_UNIX_STYLE
:SET &UC4RB_AIOPS_JB_HOME_DIR# = &UC4RB_CONVERTED_STRING#

:INCLUDE PCK.AUTOMIC_JBOSS_V7.PRV.INCLUDE.JBOSS_CLI_TOOL@UNIX

!---------------------- Enable application command  ----------------------
:SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI# --command="deploy --name=&UC4RB_AIOPS_JB_APP_NAME#'

:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Managed Domain"
:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# = ""
:    SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI_ENABLE_APP# --all-server-groups'
:  ELSE
:    SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI_ENABLE_APP# --server-groups=&UC4RB_AIOPS_JB_SERVER_GRPS#'
:  ENDIF
:ENDIF

:SET &UC4_JBOSS_CLI_ENABLE_APP# = '&UC4_JBOSS_CLI_ENABLE_APP#"'

! --------------------------------------

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'set NOPAUSE="True" &NL#')

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ ! -d "&UC4RB_AIOPS_JB_HOME_DIR#" ]; then &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  echo "ERROR: ERROR: Cannot find the JBoss path. Aborting ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  exit 1 &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'output=`&UC4_JBOSS_CLI# --command="quit"` &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ "`echo "$output" | grep "Failed to connect to the controller"`" ]; then &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  echo "ERROR: JBoss is not running or cannot connect to JBoss CLI using the given inputs. Aborting ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  exit 1 &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'echo "Checking &UC4RB_AIOPS_JB_APP_NAME# status ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'output=`&UC4_JBOSS_CLI# --command="deployment-info --name=&UC4RB_AIOPS_JB_APP_NAME#"` &NL#')

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ "`echo "$output" | grep " not found"`" ]; then &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  echo "&UC4RB_AIOPS_JB_APP_NAME# does not exist. Aborting ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  exit 1 &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

! In Standalone mode, application state can be checked here
:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Standalone"
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  if ["`echo "$output" | grep "  FAILED *$"`" ]; then &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '    echo "&UC4RB_AIOPS_JB_APP_NAME# is currently in FAILED state. Aborting ..." &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  exit 1 &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  fi &NL#')
:ELSE
:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# NE ""
:    DEFINE &SERVER_GROUPS#,string, 100
:    FILL &SERVER_GROUPS#[] = STR_SPLIT(&UC4RB_AIOPS_JB_SERVER_GRPS#,",")
:    SET &VAR# = 1
:    WHILE &SERVER_GROUPS#[&VAR#] NE ""
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' if [ -z "`echo "$output" | grep "^&SERVER_GROUPS#[&VAR#] *"`" ]; then &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '   echo "Server group: &SERVER_GROUPS#[&VAR#] does not exist. Aborting ..." &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '   exit 1 &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' fi &NL#')
:      SET &VAR# = &VAR# + 1
:    ENDWHILE
:  ENDIF
:ENDIF

! ------------------- Enable Application -------------------

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'echo "Starting/Assigning &UC4RB_AIOPS_JB_APP_NAME# on JBoss EAP 7 (&UC4RB_AIOPS_JB_OPERATING_MODE#) ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'output=`&UC4_JBOSS_CLI_ENABLE_APP#` &NL#')

!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'RC=$? &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ "$RC" -gt "0" ] ; &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  then &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '    exit $RC; &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ "`echo "$output" | grep " operation failed "`" ]; then &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' echo "Failed to start/assign &UC4RB_AIOPS_JB_APP_NAME# in JBoss(&UC4RB_AIOPS_JB_OPERATING_MODE#). Aborting ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  exit 1 &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

! --------------------------------------

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'echo "Starting/Assigning process finished. Checking &UC4RB_AIOPS_JB_APP_NAME# status again ..." &NL#')
:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'output=`&UC4_JBOSS_CLI# --command="deployment-info --name=&UC4RB_AIOPS_JB_APP_NAME#"` &NL#')

!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'RC=$? &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'if [ "$RC" -gt "0" ] ; &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  then &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '    exit $RC; &NL#')
!:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'fi &NL#')

:IF &UC4RB_AIOPS_JB_OPERATING_MODE# = "Managed Domain"
:  IF &UC4RB_AIOPS_JB_SERVER_GRPS# = ""
!     Return error if the application is still enabled or added in 1 or more server groups
:    SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' if [ "`echo "$output" | grep " not added *$"`" ] ; then &NL#')
:    SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  echo "&UC4RB_AIOPS_JB_APP_NAME# is not assigned to all server groups." &NL#')
:    SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '   exit 1 &NL#')
:    SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' fi &NL#')
:  ELSE
:    SET &VAR# = 1
:    WHILE &SERVER_GROUPS#[&VAR#] NE ""
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' if [ -z "`echo "$output" | grep "&SERVER_GROUPS#[&VAR#] * enabled *$"`" ] ; then &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '   echo "Failed to assign &UC4RB_AIOPS_JB_APP_NAME# to server group &SERVER_GROUPS#[&VAR#]. Aborting ..." &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '   exit 1 &NL#')
:      SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, ' fi &NL#')
:      SET &VAR# = &VAR# + 1
:    ENDWHILE
:  ENDIF
:ELSE
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  if [ -z "`echo "$output" | grep " OK *$"`" ] ; then &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '    echo "&UC4RB_AIOPS_JB_APP_NAME# is not enabled in JBoss Standalone. Aborting ..." &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '    exit 1 &NL#')
:  SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, '  fi &NL#')
:ENDIF

:SET &UC4RB_CMD_UNX# = STR_CAT(&UC4RB_CMD_UNX#, 'echo "Application successfully restarted."')]]></MSCRI>
</SCRIPT>
<DOCU_Docu state="1" type="text">
<DOC/>
</DOCU_Docu>
</JOBI>
</uc-export>